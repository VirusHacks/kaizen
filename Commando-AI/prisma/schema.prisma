// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id Int @id @default(autoincrement())

  clerkId      String  @unique
  name         String?
  email        String  @unique
  profileImage String?
  tier         String? @default("Free")
  credits      String? @default("10")
  isSuperUser  Boolean @default(false)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  localGoogleId    String?  @unique
  googleResourceId String?  @unique

  LocalGoogleCredential LocalGoogleCredential?
  DiscordWebhook        DiscordWebhook[]
  Notion                Notion[]
  Slack                 Slack[]
  GitHub                GitHub[]
  connections           Connections[]
  workflows             Workflows[]
  projects              Project[]
  assignedIssues        Issue[]                @relation("IssueAssignee")
  reportedIssues        Issue[]                @relation("IssueReporter")
  projectMemberships    ProjectMember[]
}

model LocalGoogleCredential {
  id          String @id @default(uuid())
  accessToken String @unique

  folderId   String?
  pageToken  String?
  channelId  String  @unique @default(uuid())
  subscribed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])
}

model DiscordWebhook {
  id          String        @id @default(uuid())
  webhookId   String        @unique
  url         String        @unique
  name        String
  guildName   String
  guildId     String
  channelId   String        @unique
  user        User          @relation(fields: [userId], references: [clerkId])
  userId      String
  connections Connections[]
}

model Slack {
  id String @id @default(uuid())

  appId            String
  authedUserId     String
  authedUserToken  String @unique
  slackAccessToken String @unique
  botUserId        String
  teamId           String
  teamName         String

  User        User          @relation(fields: [userId], references: [clerkId])
  userId      String
  connections Connections[]
}

model Notion {
  id            String        @id @default(uuid())
  accessToken   String        @unique
  workspaceId   String        @unique
  databaseId    String        @unique
  workspaceName String
  workspaceIcon String
  User          User          @relation(fields: [userId], references: [clerkId])
  userId        String
  connections   Connections[]
}

model GitHub {
  id             String        @id @default(uuid())
  accessToken    String
  refreshToken   String?       // GitHub App OAuth refresh token
  tokenExpiresAt DateTime?     // When the access token expires
  username       String

  // GitHub App fields
  installationId Int?          // GitHub App installation ID
  appSlug        String?       // GitHub App slug (for URLs)

  User        User          @relation(fields: [userId], references: [clerkId])
  userId      String
  connections Connections[]
}

model Connections {
  id               String          @id @default(uuid())
  type             String
  DiscordWebhook   DiscordWebhook? @relation(fields: [discordWebhookId], references: [id])
  discordWebhookId String?
  Notion           Notion?         @relation(fields: [notionId], references: [id])
  notionId         String?
  User             User?           @relation(fields: [userId], references: [clerkId])
  userId           String?
  Slack            Slack?          @relation(fields: [slackId], references: [id])
  slackId          String?
  GitHub           GitHub?         @relation(fields: [githubId], references: [id])
  githubId         String?

  @@unique([type, userId])
}

model Workflows {
  id                String   @id @default(uuid())
  nodes             String?
  edges             String?
  name              String
  discordTemplate   String?
  notionTemplate    String?
  slackTemplate     String?
  slackChannels     String[]
  slackAccessToken  String?
  notionAccessToken String?
  notionDbId        String?
  flowPath          String?
  cronPath          String?
  publish           Boolean? @default(false)
  description       String
  User              User     @relation(fields: [userId], references: [clerkId])
  userId            String
}

model Project {
  id          String   @id @default(uuid())
  name        String
  key         String   @unique
  description String?
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner   User   @relation(fields: [ownerId], references: [clerkId])
  ownerId String

  issues       Issue[]
  sprints      Sprint[]
  workflows    ProjectWorkflow[]
  members      ProjectMember[]
  issueCounter Int               @default(0)

  // Extended project setup
  setup ProjectSetup?

  // Resource Allocation & Scheduling
  planningSnapshots   PlanningCycleSnapshot[]
  resourceAllocations ResourceAllocation[]
  resourceConfig      ResourceConfig?
  resourceAuditLogs   ResourceAuditLog[]

  // Agentic Collaboration
  agentProfiles  AgentProfile[]
  agentMessages  AgentMessage[]
  agentDecisions AgentDecision[]

  // Predictive Delivery Engine
  deliveryPredictions  DeliveryPrediction[]
  deliveryCommitments  DeliveryCommitment[]
  deliveryScenarios    DeliveryScenario[]
  dependencyChains     DependencyChain[]
  velocitySnapshots    VelocitySnapshot[]
}

model ProjectSetup {
  id        String @id @default(uuid())
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String @unique

  // Timeline
  startDate DateTime?
  endDate   DateTime?

  // Team
  teamSize  Int?

  // Technical context
  techStack   String?   // stored as comma-separated or multi-line
  vision      String?   // project goal / vision
  aiInstructions String? // additional instructions for AI

  // GitHub integration
  githubRepoUrl   String?
  githubRepoName  String?
  githubRepoOwner String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// TEAM MANAGEMENT
// ==========================================

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum DepartmentRole {
  DEVELOPER
  QA_TESTER
  FINANCE
  SALES
  EXECUTIVE
  PROJECT_MANAGER
}

model ProjectMember {
  id             String          @id @default(uuid())
  role           ProjectRole     @default(MEMBER)
  departmentRole DepartmentRole? // Optional department role for accessing specific dashboards
  memberId       String?         // Custom member ID for project access
  password       String?         // Hashed password for project access
  joinedAt       DateTime        @default(now())

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  user   User   @relation(fields: [userId], references: [clerkId])
  userId String

  @@unique([projectId, memberId])
  @@index([projectId])
  @@index([userId])
  @@index([memberId])
}

// Issue Management Enums
enum IssueType {
  EPIC
  STORY
  TASK
  BUG
  SUBTASK
}

enum IssueStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum SprintStatus {
  PLANNED
  ACTIVE
  COMPLETED
}

model Sprint {
  id        String       @id @default(uuid())
  name      String
  goal      String?
  startDate DateTime?
  endDate   DateTime?
  status    SprintStatus @default(PLANNED)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  issues Issue[]
  velocitySnapshots VelocitySnapshot[]

  @@index([projectId])
  @@index([status])
}

model Issue {
  id          String        @id @default(uuid())
  number      Int
  title       String
  description String?
  type        IssueType     @default(TASK)
  status      IssueStatus   @default(TODO)
  priority    IssuePriority @default(MEDIUM)
  startDate   DateTime?
  dueDate     DateTime?
  isArchived  Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  assignee   User?   @relation("IssueAssignee", fields: [assigneeId], references: [clerkId])
  assigneeId String?

  reporter   User   @relation("IssueReporter", fields: [reporterId], references: [clerkId])
  reporterId String

  // Self-relation for subtasks
  parent   Issue?  @relation("IssueSubtasks", fields: [parentId], references: [id])
  parentId String?
  children Issue[] @relation("IssueSubtasks")

  // Sprint relation (null = Backlog)
  sprint   Sprint? @relation(fields: [sprintId], references: [id])
  sprintId String?

  @@unique([projectId, number])
  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([sprintId])
  @@index([dueDate])
}

// ==========================================
// WORKFLOW ENGINE
// ==========================================

// Project Workflow - defines status flow rules for a project
model ProjectWorkflow {
  id          String   @id @default(uuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  statuses    WorkflowStatus[]
  transitions WorkflowTransition[]

  @@unique([projectId, name])
  @@index([projectId])
}

// Workflow Status - represents a status in the workflow with ordering
model WorkflowStatus {
  id          String @id @default(uuid())
  status      String // Maps to IssueStatus enum value (TODO, IN_PROGRESS, etc.)
  displayName String
  order       Int    @default(0)
  color       String @default("#6B7280") // Hex color for UI
  
  // Position for React Flow editor (node positions)
  positionX   Float  @default(0)
  positionY   Float  @default(0)

  // Relations
  workflow   ProjectWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  workflowId String

  // Transitions from/to this status
  transitionsFrom WorkflowTransition[] @relation("TransitionFrom")
  transitionsTo   WorkflowTransition[] @relation("TransitionTo")

  @@unique([workflowId, status])
  @@index([workflowId])
}

// Workflow Transition - defines allowed status changes
model WorkflowTransition {
  id               String  @id @default(uuid())
  name             String? // Optional name like "Start Work", "Complete"
  requiresAssignee Boolean @default(false)
  requiresComment  Boolean @default(false)

  // Relations
  workflow   ProjectWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  workflowId String

  fromStatus   WorkflowStatus @relation("TransitionFrom", fields: [fromStatusId], references: [id], onDelete: Cascade)
  fromStatusId String

  toStatus   WorkflowStatus @relation("TransitionTo", fields: [toStatusId], references: [id], onDelete: Cascade)
  toStatusId String

  // Allowed roles (stored as JSON array of role strings)
  // Empty array = all roles allowed
  allowedRoles String[] @default([])

  @@unique([workflowId, fromStatusId, toStatusId])
  @@index([workflowId])
  @@index([fromStatusId])
  @@index([toStatusId])
}

// ==========================================
// DASHBOARD ANALYTICS
// ==========================================

model DashboardAnalytics {
  id        String   @id @default(uuid())
  userId    Int      @unique
  
  // Analytics data stored as JSON
  monthlySales     Json?
  aovTrend         Json?
  topCountries     Json?
  topProducts      Json?
  topCustomers     Json?
  rfmDistribution  Json?
  revenueByDay     Json?
  revenueByHour    Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ForecastAnalytics {
  id        String   @id @default(uuid())
  userId    Int      @unique
  
  periods   Int      @default(6)
  
  // Forecast data stored as JSON
  revenueForecast Json?
  aovForecast     Json?
  ordersForecast  Json?
  
  lastCalculated DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ==========================================
// RESOURCE ALLOCATION & SCHEDULING
// ==========================================

enum RecommendationStatus {
  PENDING
  ACCEPTED
  MODIFIED
  REJECTED
}

enum RecommendationType {
  REASSIGN_TASK
  DELAY_TASK
  SPLIT_TASK
  ADD_REVIEWER
  SUGGEST_EXTERNAL
  REBALANCE_WORKLOAD
}

// Captures a snapshot of team/project state at each planning cycle
model PlanningCycleSnapshot {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Snapshot data stored as JSON
  taskBacklog         Json   // { totalTasks, byStatus, byPriority, dependencies }
  currentAssignments  Json   // { userId -> [taskIds] }
  capacityMap         Json   // { userId -> { available, used, max, velocity } }
  sprintDeadlines     Json   // { sprintId -> deadline }
  costRates           Json   // { userId -> hourlyRate }
  overworkIndicators  Json   // { userId -> { score, hoursThisWeek, avgHours, trend } }
  deliveryConfidence  Float  @default(0) // 0-100 percentage

  cycleType           String @default("DAILY") // DAILY or WEEKLY
  createdAt           DateTime @default(now())

  recommendations Recommendation[]

  @@index([projectId])
  @@index([createdAt])
}

// Individual recommendation generated by the system
model Recommendation {
  id          String             @id @default(uuid())
  snapshotId  String
  snapshot    PlanningCycleSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  type        RecommendationType
  status      RecommendationStatus @default(PENDING)

  // What the recommendation proposes
  title       String
  description String
  reason      String

  // The action details (JSON: { taskId, fromUserId, toUserId, etc. })
  actionPayload Json

  // Impact metrics
  deliveryProbabilityChange Float  @default(0) // e.g., +21%
  costImpactPercent         Float  @default(0) // e.g., +4%
  burnoutRiskChange         Float  @default(0) // e.g., -15%
  impactScore               Float  @default(0) // composite ranking score

  // User decision
  decidedBy     String?    // clerkId
  decidedAt     DateTime?
  rejectionReason String?
  modifiedAction  Json?    // if user modified the recommendation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  outcomes RecommendationOutcome[]

  @@index([snapshotId])
  @@index([status])
  @@index([type])
}

// Tracks what actually happened after a recommendation was accepted
model RecommendationOutcome {
  id               String         @id @default(uuid())
  recommendationId String
  recommendation   Recommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  // Actual results
  actualDeliveryChange Float?
  actualCostChange     Float?
  actualBurnoutChange  Float?
  taskCompletedOnTime  Boolean?
  notes                String?

  measuredAt DateTime @default(now())

  @@index([recommendationId])
}

// Per-member resource allocation tracking
model ResourceAllocation {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId       String  // clerkId
  sprintId     String?

  // Capacity tracking
  totalCapacityHours  Float  @default(40)  // max hours per week
  allocatedHours      Float  @default(0)
  availableHours      Float  @default(40)

  // Cost
  hourlyRate     Float   @default(0)
  costThisSprint Float   @default(0)

  // Performance
  velocityScore    Float  @default(1.0) // historical velocity multiplier
  skillTags        String[] // e.g., ["backend", "frontend", "devops"]

  // Burnout tracking
  burnoutRiskScore    Float   @default(0) // 0-100
  consecutiveOvertimeWeeks Int @default(0)
  averageWeeklyHours  Float   @default(40)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId, sprintId])
  @@index([projectId])
  @@index([userId])
}

// Organization-level configuration for reward weights
model ResourceConfig {
  id        String @id @default(uuid())
  projectId String @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Reward function weights (must sum to 1.0 ideally)
  deliverySlippageWeight Float @default(0.4)
  costOverrunWeight      Float @default(0.2)
  overworkWeight         Float @default(0.25)
  onTimeBonusWeight      Float @default(0.15)

  // Planning cycle config
  planningCycleType   String  @default("DAILY") // DAILY or WEEKLY
  maxChangesPerCycle  Int     @default(5)
  learningEnabled     Boolean @default(true)

  // Thresholds
  burnoutThreshold     Float @default(70) // burnout risk score threshold
  overworkHoursWeekly  Float @default(50) // hours/week considered overwork
  idleThresholdPercent Float @default(30) // utilization below this = idle

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
}

// Audit log for all resource planning actions
model ResourceAuditLog {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  action      String   // RECOMMENDATION_GENERATED, ACCEPTED, REJECTED, MODIFIED, OUTCOME_RECORDED
  actorId     String?  // clerkId of who performed the action
  entityType  String   // RECOMMENDATION, ALLOCATION, SNAPSHOT
  entityId    String
  details     Json     // full context

  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([createdAt])
  @@index([action])
}

// ==========================================
// AGENTIC COLLABORATION SYSTEM
// ==========================================

enum AgentType {
  DEVELOPER
  MANAGER
  QA
  OPTIMIZER
  SCHEDULER
}

enum AgentStatus {
  ACTIVE
  IDLE
  PAUSED
  DISABLED
}

enum AgentMessageType {
  STATUS_UPDATE
  HELP_REQUEST
  TASK_OFFER
  NEGOTIATION_PROPOSAL
  NEGOTIATION_RESPONSE
  APPROVAL_REQUEST
  APPROVAL_RESPONSE
  ALERT
  BROADCAST
  PLANNING_TRIGGER
}

enum AgentMessageStatus {
  PENDING
  ACKNOWLEDGED
  RESOLVED
  EXPIRED
  CANCELLED
}

enum AgentDecisionType {
  TASK_REASSIGNMENT
  DEADLINE_EXTENSION
  HELP_REQUEST
  WORKLOAD_REBALANCE
  BLOCKER_ESCALATION
  REVIEW_ASSIGNMENT
  SPRINT_REPLANNING
  BURNOUT_ALERT
}

enum AgentDecisionStatus {
  PROPOSED
  APPROVED_BY_AGENT
  PENDING_HUMAN
  APPROVED_BY_HUMAN
  REJECTED_BY_HUMAN
  AUTO_EXECUTED
  EXPIRED
}

enum AutonomyLevel {
  MONITOR     // Observe only
  SUGGEST     // Propose actions, no auto-execution
  NEGOTIATE   // Agents negotiate, humans approve
  LOW_RISK    // Auto-execute low-risk, approve high-risk
  FULL_AUTO   // Full autonomy with daily digest
}

// Per-member AI agent profile
model AgentProfile {
  id        String      @id @default(uuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  userId    String      // clerkId of the team member this agent represents
  agentType AgentType
  status    AgentStatus @default(ACTIVE)

  // Agent state (persisted between runs)
  currentState   Json    @default("{}") // { activeGoals, blockers, recentActions, mood }
  memory         Json    @default("[]") // Recent context window for LLM
  preferences    Json    @default("{}") // { autoAcceptThreshold, communicationStyle }

  // Performance tracking
  trustScore        Float @default(0.5) // 0-1, how often humans agree with this agent
  decisionsProposed Int   @default(0)
  decisionsAccepted Int   @default(0)
  totalInteractions Int   @default(0)

  // Scheduling
  lastRunAt    DateTime?
  nextRunAt    DateTime?
  runInterval  Int       @default(600) // seconds between runs (default 10min)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sentMessages     AgentMessage[] @relation("SentMessages")
  receivedMessages AgentMessage[] @relation("ReceivedMessages")
  decisions        AgentDecision[]

  @@unique([projectId, userId, agentType])
  @@index([projectId])
  @@index([userId])
  @@index([status])
}

// Agent-to-agent communication
model AgentMessage {
  id        String @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  fromAgentId String
  fromAgent   AgentProfile @relation("SentMessages", fields: [fromAgentId], references: [id], onDelete: Cascade)

  toAgentId   String?      // null = broadcast to all project agents
  toAgent     AgentProfile? @relation("ReceivedMessages", fields: [toAgentId], references: [id], onDelete: Cascade)

  messageType   AgentMessageType
  status        AgentMessageStatus @default(PENDING)
  priority      Int                @default(5) // 1=critical, 10=low

  // Content
  subject   String
  payload   Json       // Structured message body
  reasoning String?    // LLM reasoning trace

  // Threading
  threadId  String?    // Group related messages into conversations
  parentId  String?    // Reply-to message ID
  parent    AgentMessage?  @relation("MessageThread", fields: [parentId], references: [id])
  replies   AgentMessage[] @relation("MessageThread")

  // Metadata
  expiresAt DateTime?
  readAt    DateTime?

  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([fromAgentId])
  @@index([toAgentId])
  @@index([threadId])
  @@index([messageType])
  @@index([status])
  @@index([createdAt])
}

// Agent decision audit trail
model AgentDecision {
  id        String @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  agentId String
  agent   AgentProfile @relation(fields: [agentId], references: [id], onDelete: Cascade)

  decisionType   AgentDecisionType
  status         AgentDecisionStatus @default(PROPOSED)

  // What the agent decided
  title       String
  description String
  reasoning   String   // Full LLM reasoning trace
  confidence  Float    @default(0.5) // 0-1

  // Action details
  actionPayload Json   // { taskId, fromUser, toUser, delayDays, etc }
  impactEstimate Json  @default("{}") // { deliveryChange, costChange, burnoutChange }

  // Human review
  reviewedBy    String?    // clerkId
  reviewedAt    DateTime?
  reviewNote    String?

  // Outcome tracking
  wasExecuted   Boolean  @default(false)
  executedAt    DateTime?
  actualOutcome Json?    // Measured results

  // Related messages (the negotiation that led to this decision)
  relatedThreadId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([agentId])
  @@index([decisionType])
  @@index([status])
  @@index([createdAt])
}

// ==========================================
// Predictive Delivery Engine Models
// ==========================================

enum PredictionConfidence {
  LOW         // < 50%
  MEDIUM      // 50-70%
  HIGH        // 70-85%
  VERY_HIGH   // > 85%
}

enum CommitmentStatus {
  PENDING
  ON_TRACK
  AT_RISK
  DELAYED
  DELIVERED
  MISSED
}

// Stores Monte Carlo simulation results for features/milestones
model DeliveryPrediction {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // What we're predicting
  targetId     String // Issue ID, Sprint ID, or Milestone ID
  targetType   String // "ISSUE", "SPRINT", "MILESTONE", "FEATURE_GROUP"
  targetTitle  String

  // Prediction results (from Monte Carlo simulation)
  p50Date      DateTime // 50% confidence date (median)
  p70Date      DateTime // 70% confidence date
  p85Date      DateTime // 85% confidence date
  p90Date      DateTime // 90% confidence date
  
  confidence   PredictionConfidence
  
  // Velocity assumptions
  historicalVelocity     Float   // Story points per sprint
  currentTeamCapacity    Float   // Available hours per sprint
  remainingComplexity    Float   // Estimated story points remaining
  
  // Risk factors
  dependencyCount        Int     @default(0)
  criticalPathLength     Int     @default(0) // Days on critical path
  teamBurnoutRisk        Float   @default(0)
  externalDependencies   Int     @default(0)
  
  // Simulation metadata
  simulationRuns         Int     @default(10000)
  simulationMethod       String  @default("monte_carlo")
  assumptions            Json    // Store assumptions as JSON
  
  // Scenario analysis
  bestCase      DateTime // Optimistic scenario
  worstCase     DateTime // Pessimistic scenario
  mostLikely    DateTime // Mode of distribution
  
  // Predictions refresh daily or on major changes
  calculatedAt  DateTime @default(now())
  validUntil    DateTime // Invalidate after project changes
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([targetId])
  @@index([targetType])
  @@index([validUntil])
}

// Tracks commitments made to stakeholders/customers
model DeliveryCommitment {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // What was committed
  commitmentType  String // "FEATURE", "SPRINT", "MILESTONE", "RELEASE"
  targetId        String // Issue ID, Sprint ID, etc.
  targetTitle     String
  description     String?
  
  // Commitment details
  committedDate   DateTime // When we promised delivery
  committedTo     String   // Stakeholder/customer name
  committedBy     String   // User who made commitment (e.g., sales rep)
  
  // Tracking
  status          CommitmentStatus @default(PENDING)
  actualDelivery  DateTime?
  daysEarly       Int?     // Positive if early, negative if late
  
  // Confidence tracking
  initialConfidence   Float  // Confidence when commitment made
  currentConfidence   Float? // Current confidence (updated daily)
  
  // Risk tracking
  riskLevel           String  @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL
  riskFactors         Json?   // Array of risk descriptions
  
  // Financial impact (if applicable)
  revenueImpact       Float?  // $ tied to this commitment
  penaltyClause       Float?  // $ penalty if missed
  
  // Alerts
  earlyWarningIssued  Boolean @default(false)
  warningIssuedAt     DateTime?
  daysBeforeMiss      Int?    // How many days before miss was warning issued
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([committedDate])
  @@index([riskLevel])
}

// Stores what-if scenario results
model DeliveryScenario {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name        String
  description String?
  
  // Scenario parameters (what changes)
  changes     Json // e.g., { "addDevelopers": 2, "reduceScope": 10 }
  
  // Impact results
  originalP70Date    DateTime
  scenarioP70Date    DateTime
  daysSaved          Int      // Positive if faster, negative if slower
  
  confidenceChange   Float    // Change in delivery confidence %
  costImpact         Float?   // $ increase/decrease
  riskImpact         String?  // Description of new risks
  
  // Metadata
  createdBy   String
  isActive    Boolean  @default(false) // True if scenario is being executed
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([isActive])
}

// Tracks dependency chains and their impact
model DependencyChain {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Root issue that blocks others
  rootIssueId     String
  rootIssueTitle  String
  
  // Chain metadata
  chainLength     Int    // How many issues in chain
  totalDaysAtRisk Int    // Sum of task durations in chain
  
  // Impact analysis
  blockedIssues   Json   // Array of {issueId, title, estimatedDelay}
  criticalPath    Boolean @default(false)
  
  // Risk scoring
  riskScore       Float  // 0-100, higher = more critical
  impactRadius    Int    // How many features affected
  
  lastAnalyzedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([rootIssueId])
  @@index([criticalPath])
}

// Historical velocity tracking for ML predictions
model VelocitySnapshot {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  sprintId  String?
  sprint    Sprint?  @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  
  // Velocity metrics
  weekStart       DateTime
  weekEnd         DateTime
  storyPoints     Float    // Points completed
  tasksCompleted  Int
  
  // Team metrics
  teamSize        Int
  avgUtilization  Float
  avgBurnout      Float
  
  // Quality metrics
  bugsCreated     Int @default(0)
  reworkHours     Float @default(0)
  
  createdAt DateTime @default(now())

  @@index([projectId])
  @@index([weekStart])
}
